apiVersion: v1
kind: ConfigMap
metadata:
  name: clamav-conf
  namespace: email-system
data:
  clamd.conf: |
    LogTime yes
    TCPSocket 3310
    TCPAddr 0.0.0.0
    MaxThreads 12
    Foreground yes
    PidFile /run/clamav/clamd.pid
    DatabaseDirectory /var/lib/clamav
  freshclam.conf: |
    DatabaseMirror database.clamav.net
    UpdateLogFile /var/log/clamav/freshclam.log
    Checks 12
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: clamav
  namespace: email-system
spec:
  replicas: 1
  selector: { matchLabels: { app: clamav } }
  template:
    metadata: { labels: { app: clamav } }
    spec:
      initContainers:
        - name: seed-db
          image: clamav/clamav:1.3
          command: ["sh","-c","freshclam --foreground --datadir=/var/lib/clamav || true"]
          volumeMounts:
            - { name: db, mountPath: /var/lib/clamav }
      containers:
        - name: clamd
          image: clamav/clamav:1.3
          args: ["-c","/etc/clamav/clamd.conf"]
          ports: [{ containerPort: 3310 }]
          resources:
            requests: { cpu: "200m", memory: "1Gi" }
            limits:   { cpu: "2",    memory: "3Gi" }
          volumeMounts:
            - { name: conf, mountPath: /etc/clamav }
            - { name: db,   mountPath: /var/lib/clamav }
        - name: freshclam
          image: clamav/clamav:1.3
          args: ["freshclam","--foreground","--daemon"]
          volumeMounts:
            - { name: conf, mountPath: /etc/clamav }
            - { name: db,   mountPath: /var/lib/clamav }
      volumes:
        - name: conf
          configMap: { name: clamav-conf }
        - name: db
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: clamav
  namespace: email-system
spec:
  selector: { app: clamav }
  ports:
    - { name: clamd, port: 3310, targetPort: 3310 }
