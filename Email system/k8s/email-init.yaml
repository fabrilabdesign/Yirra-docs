apiVersion: batch/v1
kind: Job
metadata:
  name: email-init
  namespace: email-system
spec:
  template:
    spec:
      containers:
      - name: init
        image: postgres:15
        command: ["/bin/bash", "-c"]
        args:
        - |
          # Wait for PostgreSQL to be ready
          until psql -h email-postgres.email-system.svc.cluster.local -U postgres -c "SELECT 1;" >/dev/null 2>&1; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

          # Create Roundcube database and user
          psql -h email-postgres.email-system.svc.cluster.local -U postgres -c "
            CREATE DATABASE IF NOT EXISTS roundcubedb;
            CREATE USER IF NOT EXISTS roundcube WITH ENCRYPTED PASSWORD 'roundcube';
            GRANT ALL PRIVILEGES ON DATABASE roundcubedb TO roundcube;
          "

          echo "Database initialization complete"
      restartPolicy: Never
